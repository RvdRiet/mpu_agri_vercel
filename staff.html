<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#2d5a27">
  <title>Staff Portal — Applications — Mpumalanga AgriSupport</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="nav.css">
  <link rel="stylesheet" href="track.css">
  <link rel="stylesheet" href="account.css">
  <link rel="stylesheet" href="staff.css">
</head>
<body>
  <div class="page-wrapper">

    <!-- ===== NAVIGATION ===== -->
    <nav class="site-nav" role="navigation" aria-label="Main navigation">
      <div class="site-nav__inner">
        <a href="index.html" class="site-nav__brand">
          <img src="images/mpumalanga.webp" alt="" class="site-nav__logo" aria-hidden="true" />
          <span class="site-nav__brand-text">
            <span class="site-nav__brand-name">Mpumalanga AgriSupport</span>
            <span class="site-nav__brand-sub">Decision Support System</span>
          </span>
        </a>
        <div class="site-nav__links">
          <div class="nav-item"><a href="index.html" class="nav-link">Home</a></div>
          <div class="nav-item">
            <button class="nav-link" type="button" aria-expanded="false">Programmes <span class="nav-link__arrow" aria-hidden="true">&#9660;</span></button>
            <div class="nav-dropdown" role="menu">
              <a href="crop.html" class="nav-dropdown__link" role="menuitem"><span class="nav-dropdown__icon">&#127806;</span><span class="nav-dropdown__text"><span class="nav-dropdown__label">Crop Management</span><span class="nav-dropdown__desc">Crop farming support &amp; grants</span></span></a>
              <a href="livestock.html" class="nav-dropdown__link" role="menuitem"><span class="nav-dropdown__icon">&#128004;</span><span class="nav-dropdown__text"><span class="nav-dropdown__label">Livestock Management</span><span class="nav-dropdown__desc">Livestock development &amp; grants</span></span></a>
              <a href="environmental.html" class="nav-dropdown__link" role="menuitem"><span class="nav-dropdown__icon">&#127795;</span><span class="nav-dropdown__text"><span class="nav-dropdown__label">Environmental Enrichment</span><span class="nav-dropdown__desc">Conservation &amp; sustainability</span></span></a>
            </div>
          </div>
          <div class="nav-item"><a href="weather.html" class="nav-link">Weather</a></div>
          <div class="nav-item"><a href="alerts.html" class="nav-link">Alerts</a></div>
          <div class="nav-item"><a href="guides.html" class="nav-link">Guides</a></div>
          <div class="nav-item"><a href="e-learning.html" class="nav-link">E-learning</a></div>
          <div class="nav-item"><a href="support.html" class="nav-link">Support</a></div>
          <div class="nav-item">
            <button class="nav-link" type="button" aria-expanded="false">Apply <span class="nav-link__arrow" aria-hidden="true">&#9660;</span></button>
            <div class="nav-dropdown" role="menu">
              <a href="Application/crop.html" class="nav-dropdown__link" role="menuitem"><span class="nav-dropdown__icon">&#128196;</span><span class="nav-dropdown__text"><span class="nav-dropdown__label">Crop Grant</span><span class="nav-dropdown__desc">Apply for crop development support</span></span></a>
              <a href="Application/index.html" class="nav-dropdown__link" role="menuitem"><span class="nav-dropdown__icon">&#128196;</span><span class="nav-dropdown__text"><span class="nav-dropdown__label">Livestock Grant</span><span class="nav-dropdown__desc">Masibuyele Esibayeni Programme</span></span></a>
              <a href="Application/environmental.html" class="nav-dropdown__link" role="menuitem"><span class="nav-dropdown__icon">&#128196;</span><span class="nav-dropdown__text"><span class="nav-dropdown__label">Environmental Grant</span><span class="nav-dropdown__desc">Conservation &amp; enrichment funding</span></span></a>
              <div class="nav-dropdown__divider"></div>
              <a href="track.html" class="nav-dropdown__link" role="menuitem"><span class="nav-dropdown__icon">&#128269;</span><span class="nav-dropdown__text"><span class="nav-dropdown__label">Track Application</span><span class="nav-dropdown__desc">Check your application status</span></span></a>
            </div>
          </div>
        </div>
        <div class="site-nav__actions">
          <a href="staff-login.html" class="nav-link active">Staff Portal</a>
          <a href="staff.html" class="nav-cta">Applications</a>
        </div>
        <button class="nav-toggle" id="navToggle" type="button" aria-label="Toggle menu" aria-expanded="false"><span class="nav-toggle__bar"></span></button>
      </div>
      <div class="site-nav__mobile" id="mobileNav">
        <div class="mobile-nav__section"><div class="mobile-nav__heading">Navigation</div><a href="index.html" class="mobile-nav__link"><span class="mobile-nav__icon">&#127968;</span> Home</a><a href="weather.html" class="mobile-nav__link"><span class="mobile-nav__icon">&#9925;</span> Weather</a><a href="alerts.html" class="mobile-nav__link"><span class="mobile-nav__icon">&#9888;</span> Alerts</a><a href="guides.html" class="mobile-nav__link"><span class="mobile-nav__icon">&#128214;</span> Guides</a><a href="e-learning.html" class="mobile-nav__link"><span class="mobile-nav__icon">&#128218;</span> E-learning</a><a href="support.html" class="mobile-nav__link"><span class="mobile-nav__icon">&#128222;</span> Support</a></div>
        <div class="mobile-nav__section"><div class="mobile-nav__heading">Programmes</div><a href="crop.html" class="mobile-nav__link"><span class="mobile-nav__icon">&#127806;</span> Crop Management</a><a href="livestock.html" class="mobile-nav__link"><span class="mobile-nav__icon">&#128004;</span> Livestock Management</a><a href="environmental.html" class="mobile-nav__link"><span class="mobile-nav__icon">&#127795;</span> Environmental Enrichment</a></div>
        <div class="mobile-nav__section"><div class="mobile-nav__heading">Applications</div><a href="Application/crop.html" class="mobile-nav__link"><span class="mobile-nav__icon">&#128196;</span> Crop Grant Application</a><a href="Application/index.html" class="mobile-nav__link"><span class="mobile-nav__icon">&#128196;</span> Livestock Grant Application</a><a href="Application/environmental.html" class="mobile-nav__link"><span class="mobile-nav__icon">&#128196;</span> Environmental Grant Application</a><a href="track.html" class="mobile-nav__link"><span class="mobile-nav__icon">&#128269;</span> Track Application</a></div>
        <div class="mobile-nav__actions"><a href="staff-login.html" class="btn btn--secondary btn--block">Staff Portal</a><button type="button" class="btn btn--primary btn--block" id="mobileStaffLogout">Logout</button></div>
      </div>
      <div class="mobile-nav-overlay" id="mobileOverlay"></div>
    </nav>

    <!-- ===== PAGE HEADER ===== -->
    <section class="page-header">
      <div class="container">
        <nav class="breadcrumbs" aria-label="Breadcrumb">
          <a href="index.html">Home</a>
          <span class="breadcrumbs__sep" aria-hidden="true">/</span>
          <span class="breadcrumbs__current">Staff Portal</span>
        </nav>
        <h1 class="page-header__title">Staff Portal</h1>
        <p class="page-header__subtitle">Review and manage submitted applications. View details, approve or deny claims.</p>
      </div>
    </section>

    <!-- ===== MAIN CONTENT ===== -->
    <main class="account-page">
      <div class="container">
        <div class="track-user-bar" id="staffUserBar">
          <span class="track-user-info">Signed in as <strong id="staffUserName"></strong></span>
          <button type="button" class="track-logout-btn" id="staffLogout">Logout</button>
        </div>

        <section class="account-section" id="staffSection">
          <h2 class="account-section__title">Applications</h2>
          <p class="account-section__desc">All submitted applications. View full details, then approve or deny each claim.</p>

          <div id="staffList" class="staff-table-wrap">
            <table class="staff-table">
              <thead>
                <tr>
                  <th>Reference</th>
                  <th>Applicant ID</th>
                  <th>Submitted</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="staffTableBody"></tbody>
            </table>
          </div>
          <div id="staffEmpty" class="staff-empty" hidden>
            <p>No applications have been submitted yet.</p>
          </div>
        </section>
      </div>
    </main>

    <!-- ===== FOOTER ===== -->
    <footer class="site-footer">
      <div class="footer__top"><div class="container"><div class="footer__grid">
        <div><p class="footer__brand-name">Mpumalanga AgriSupport</p><p class="footer__brand-text">Agricultural Decision Support System for the Mpumalanga Department of Agriculture.</p></div>
        <div><h4 class="footer__heading">Programmes</h4><div class="footer__links"><a href="crop.html">Crop Management</a><a href="livestock.html">Livestock Management</a><a href="environmental.html">Environmental Enrichment</a></div></div>
        <div><h4 class="footer__heading">Resources</h4><div class="footer__links"><a href="weather.html">Weather Data</a><a href="alerts.html">Farming Alerts</a><a href="guides.html">Advisory Guides</a><a href="support.html">Support Contacts</a><a href="track.html">Track Application</a></div></div>
        <div><h4 class="footer__heading">Legal</h4><div class="footer__links"><a href="popia.html">POPIA Compliance</a><a href="terms.html">Terms of Service</a><a href="staff-login.html">Staff Portal</a></div></div>
      </div></div></div>
      <div class="footer__bottom"><div class="container"><div class="footer__bottom-inner"><span>&copy; 2025 Mpumalanga Department of Agriculture. All rights reserved.</span><div class="footer__bottom-links"><a href="popia.html">Privacy</a><a href="terms.html">Terms</a></div></div></div></div>
    </footer>

  </div>

  <div class="staff-modal-overlay" id="detailModal" hidden role="dialog" aria-labelledby="detailModalTitle" aria-modal="true">
    <div class="staff-modal">
      <div class="staff-modal-header">
        <h3 id="detailModalTitle">Application details</h3>
        <button type="button" class="staff-modal-close" id="detailModalClose" aria-label="Close">Close</button>
      </div>
      <div class="staff-modal-body" id="detailModalBody"></div>
    </div>
  </div>

  <script src="js/security.js"></script>
  <script src="js/staff-auth.js"></script>
  <script src="js/applications.js"></script>
  <script src="js/nav.js"></script>
  <script>
    (function () {
      if (!window.FarmStaffAuth || !FarmStaffAuth.getCurrentStaff()) {
        window.location.href = 'staff-login.html?return=staff.html';
        return;
      }
      var staff = FarmStaffAuth.getCurrentStaff();
      document.getElementById('staffUserName').textContent = (staff.name || staff.username);
      document.getElementById('staffLogout').onclick = function () {
        FarmStaffAuth.logout();
        window.location.href = 'staff-login.html';
      };
      var mobileLogout = document.getElementById('mobileStaffLogout');
      if (mobileLogout) mobileLogout.onclick = function () { FarmStaffAuth.logout(); window.location.href = 'staff-login.html'; };

      function formatLabel(key) {
        if (!key) return '';
        return key
          .replace(/([A-Z])/g, ' $1')
          .replace(/[_\-]/g, ' ')
          .replace(/^\s+/, '')
          .split(' ')
          .map(function (w) { return w.charAt(0).toUpperCase() + w.slice(1).toLowerCase(); })
          .join(' ');
      }

      function formatDate(iso) {
        try {
          return new Date(iso).toLocaleDateString('en-ZA', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        } catch (e) {
          return iso || '—';
        }
      }

      function statusClass(s) {
        var v = (s || '').toLowerCase().replace(/\s/g, '-');
        if (v === 'approved') return 'staff-status-approved';
        if (v === 'rejected' || v === 'denied') return 'staff-status-rejected';
        if (v === 'under-review') return 'staff-status-under-review';
        return 'staff-status-submitted';
      }

      function esc(str) {
        if (str === true || str === false) return str ? 'Yes' : 'No';
        return window.FarmSecurity && window.FarmSecurity.escapeHtml ? window.FarmSecurity.escapeHtml(String(str || '')) : String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      }

      function renderDetails(details) {
        if (!details || typeof details !== 'object') return '<p>No details stored.</p>';
        var keys = Object.keys(details).filter(function (k) { return details[k] !== '' && details[k] != null; }).sort();
        if (keys.length === 0) return '<p>No details stored.</p>';
        var html = '<dl class="staff-detail-dl">';
        keys.forEach(function (k) {
          html += '<dt>' + esc(formatLabel(k)) + '</dt><dd>' + (details[k] === true ? 'Yes' : details[k] === false ? 'No' : esc(details[k])) + '</dd>';
        });
        html += '</dl>';
        return html;
      }

      function openDetail(userId, app) {
        var body = document.getElementById('detailModalBody');
        var summary = app.summary || {};
        var details = app.details || {};
        var html = '<p><strong>Reference:</strong> ' + esc(app.id) + '</p>';
        html += '<p><strong>Applicant ID:</strong> ' + esc(userId) + '</p>';
        html += '<p><strong>Submitted:</strong> ' + esc(formatDate(app.submittedAt)) + '</p>';
        html += '<p><strong>Status:</strong> ' + esc(app.status) + '</p>';
        html += '<p><strong>Commodity:</strong> ' + esc(summary.commodity) + ' &nbsp; <strong>Category:</strong> ' + esc(summary.farmerCategory) + '</p>';
        html += '<p><strong>Applicant / Project:</strong> ' + esc(summary.registeredName) + '</p>';
        html += '<p><strong>Farm:</strong> ' + esc(summary.farmName) + '</p>';
        html += '<h4 style="margin-top:1.5rem; margin-bottom:0.5rem;">All form details</h4>';
        html += renderDetails(details);
        body.innerHTML = html;
        document.getElementById('detailModal').hidden = false;
        document.getElementById('detailModalTitle').textContent = 'Application ' + (app.id || '');
      }

      function setStatus(userId, appId, status) {
        if (!window.FarmApplications) return;
        FarmApplications.updateApplicationStatus(userId, appId, status).then(function () {
          renderList();
        });
      }

      function renderList() {
        var promise = window.FarmApplications ? FarmApplications.getAllApplicationsForStaff() : Promise.resolve([]);
        promise.then(function (list) {
          list = list || [];
          var tbody = document.getElementById('staffTableBody');
          var tableWrap = document.getElementById('staffList');
          var emptyEl = document.getElementById('staffEmpty');

          if (list.length === 0) {
            tableWrap.hidden = true;
            emptyEl.hidden = false;
            return;
          }
          emptyEl.hidden = true;
          tableWrap.hidden = false;

        tbody.innerHTML = list.map(function (item) {
          var uid = item.userId;
          var app = item.application;
          var ref = app.id || '—';
          var submitted = formatDate(app.submittedAt);
          var status = app.status || 'Submitted';
          var statusCls = statusClass(status);
          var approved = status === 'Approved';
          var rejected = status === 'Rejected' || status === 'Denied';
          return (
            '<tr>' +
              '<td>' + esc(ref) + '</td>' +
              '<td>' + esc(uid) + '</td>' +
              '<td>' + esc(submitted) + '</td>' +
              '<td><span class="staff-status ' + statusCls + '">' + esc(status) + '</span></td>' +
              '<td class="staff-actions-cell">' +
                '<button type="button" class="staff-btn staff-btn-view" data-userid="' + esc(uid) + '" data-appid="' + esc(ref) + '" data-action="view">View details</button>' +
                (!approved && !rejected ? '<button type="button" class="staff-btn staff-btn-approve" data-userid="' + esc(uid) + '" data-appid="' + esc(ref) + '" data-action="approve">Approve</button>' : '') +
                (!approved && !rejected ? '<button type="button" class="staff-btn staff-btn-deny" data-userid="' + esc(uid) + '" data-appid="' + esc(ref) + '" data-action="deny">Deny</button>' : '') +
              '</td>' +
            '</tr>'
          );
        }).join('');

        tbody.querySelectorAll('[data-action="view"]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var uid = btn.getAttribute('data-userid');
            var appId = btn.getAttribute('data-appid');
            var item = list.find(function (i) { return i.userId === uid && i.application.id === appId; });
            if (item) openDetail(uid, item.application);
          });
        });
        tbody.querySelectorAll('[data-action="approve"]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            if (confirm('Approve this application?')) setStatus(btn.getAttribute('data-userid'), btn.getAttribute('data-appid'), 'Approved');
          });
        });
        tbody.querySelectorAll('[data-action="deny"]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            if (confirm('Deny this application?')) setStatus(btn.getAttribute('data-userid'), btn.getAttribute('data-appid'), 'Rejected');
          });
        });
        }).catch(function () {
          document.getElementById('staffList').hidden = true;
          document.getElementById('staffEmpty').hidden = false;
          document.getElementById('staffEmpty').querySelector('p').textContent = 'Unable to load applications. Ensure you are signed in as staff.';
        });
      }

      document.getElementById('detailModalClose').addEventListener('click', function () {
        document.getElementById('detailModal').hidden = true;
      });
      document.getElementById('detailModal').addEventListener('click', function (e) {
        if (e.target === document.getElementById('detailModal')) document.getElementById('detailModal').hidden = true;
      });

      renderList();
    })();
  </script>
</body>
</html>
